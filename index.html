<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ZenChain • Simple DEX (Testnet)</title>

<!-- Ethers v6 (UMD) + fallback để tránh “ethers is not defined” -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"
        onerror="var s=document.createElement('script');s.src='https://unpkg.com/ethers@6.13.2/dist/ethers.umd.min.js';document.head.appendChild(s);">
</script>

<style>
:root{
  --bg:#060a14; --bg2:#081330;
  --glass:#0f1a3a; --stroke:#1e2a58;
  --fg:#e9efff; --muted:#a8b3d8;
  --pri:#67b8ff; --pri2:#7cffcf;
  --ok:#1ec28b; --warn:#ffb454; --err:#ff5a71;
}
*{box-sizing:border-box}
body{
  margin:0;color:var(--fg);
  background:
    radial-gradient(1200px 700px at 10% -10%, #0c3a6a 0%, transparent 55%),
    radial-gradient(900px 600px at 110% 0%, #0a644c 0%, transparent 50%),
    linear-gradient(180deg,var(--bg) 0%,var(--bg2) 100%);
  font:16px/1.45 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  min-height:100vh; overflow-x:hidden;
}
.wrap{max-width:1100px;margin:36px auto;padding:0 18px}

/* orbs nền */
.orb, .orb2{
  position:fixed; z-index:-1; filter:blur(60px); opacity:.5; pointer-events:none;
}
.orb{ width:420px;height:420px; right:-140px; top:100px;
  background:radial-gradient(circle at 50% 50%, #7cffcf 0%, transparent 60%);}
.orb2{ width:520px;height:520px; left:-180px; top:-60px;
  background:radial-gradient(circle at 50% 50%, #62a8ff 0%, transparent 60%);}

header{display:flex;align-items:center;justify-content:space-between;gap:14px}
.brand{display:flex;align-items:center;gap:14px}
.logo{
  width:60px;height:60px;border-radius:18px;display:grid;place-items:center;
  background:#0b1224;border:1px solid rgba(255,255,255,.06);
  box-shadow:0 14px 44px rgba(124,255,207,.25), inset 0 1px 0 rgba(255,255,255,.05);
}
.logo img{width:50px;height:50px;object-fit:contain;filter:drop-shadow(0 8px 24px rgba(124,255,207,.35))}
h1{margin:0;font-size:30px}
.sub{color:var(--muted);font-size:14px;margin-top:4px}

/* hero card */
.hero{
  margin-top:18px;padding:22px;border-radius:20px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.012));
  border:1px solid var(--stroke); box-shadow:0 14px 44px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
}

/* generic */
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.012));
  border:1px solid var(--stroke); border-radius:18px;padding:18px;margin:14px 0; box-shadow:0 12px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05)}
.row{display:flex;flex-wrap:wrap;gap:12px;margin:12px 0}
input,button{border-radius:12px;border:1px solid var(--stroke);outline:none;background:#0b1533;color:var(--fg);padding:10px 12px}
input{min-width:220px;flex:1}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
button{background:linear-gradient(180deg,#3a6df3,#2f58d7);color:#fff;border:0;cursor:pointer;
  padding:10px 14px;box-shadow:0 8px 28px rgba(58,109,243,.35);transition:filter .2s ease,transform .06s ease}
button:hover{filter:brightness(1.08)} button:active{transform:translateY(1px)}
button.ghost{background:#1a2650;box-shadow:none}
button.ok{background:linear-gradient(180deg,#1ec28b,#18a875);box-shadow:0 8px 28px rgba(30,194,139,.35)}
button.connected{background:linear-gradient(180deg,#1ec28b,#18a875)}
button:disabled{opacity:.65;cursor:not-allowed}

.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0b1533;border:1px solid var(--stroke);font-size:13px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
.kpi{display:flex;flex-direction:column;gap:6px}
.kpi b{font-size:13px;color:var(--muted)}
.kpi div{font-size:18px}

/* log/toast */
#log>div{padding:8px 10px;border-left:3px solid #2d3b72;background:#0b1533;margin-bottom:8px;border-radius:8px}
.oktxt{border-left-color:var(--ok)} .warnxt{border-left-color:var(--warn)} .errtxt{border-left-color:var(--err)}
.tiny{font-size:12px}

/* gallery/feature section */
.features{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-top:6px}
.feature{padding:16px;border:1px solid var(--stroke);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01))}
.feature h4{margin:0 0 6px 0}
.gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
.gallery .g{display:grid;place-items:center;padding:16px;border-radius:14px;background:#0b1533;border:1px solid var(--stroke)}
.gallery img{width:96px;height:96px;object-fit:contain;filter:drop-shadow(0 8px 24px rgba(124,255,207,.35))}
</style>
</head>
<body>
<div class="orb"></div><div class="orb2"></div>

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">
        <!-- fallback .png -> .jpg -->
        <img src="./zenchain-logo.png?v=2" alt="ZenChain" onerror="this.src='./zenchain-logo.jpg?v=2'">
      </div>
      <div>
        <h1>ZenChain Simple DEX — Testnet</h1>
        <div class="sub">Connect on ZenChain Testnet (CID 8408), approve TKN, add liquidity, then swap both ways.</div>
      </div>
    </div>
    <button id="connectBtn">🦊 Connect Wallet</button>
  </header>

  <div class="hero">
    <div class="row">
      <input id="dexAddr" class="mono" value="0x890a45b0726399552dd88A9c267532d9dd97eC92" placeholder="DEX contract"/>
      <input id="tknAddr" class="mono" value="0x363EF5235fFD8bf04834e043B8d09e713996cF65" placeholder="TKN contract"/>
      <button id="saveAddr" class="ghost">Save Addresses</button>
    </div>
    <div class="row">
      <span id="acct" class="pill mono">account: not connected</span>
      <span id="net"  class="pill mono">network: ?</span>
    </div>
    <div class="grid">
      <div class="card kpi"><b>ZTC balance</b><div id="balZTC" class="mono">-</div></div>
      <div class="card kpi"><b>TKN balance</b><div id="balTKN" class="mono">-</div></div>
      <div class="card kpi"><b>Allowance (TKN → DEX)</b><div id="allow" class="mono">-</div></div>
      <div class="card kpi"><b>Pool reserves</b><div class="mono">ZTC: <span id="rZTC">-</span> • TKN: <span id="rTKN">-</span></div></div>
    </div>
    <div class="tiny sub">Tip: addresses persist in localStorage; refresh freely.</div>
  </div>

  <div class="card">
    <h3>1) Approve TKN to the DEX</h3>
    <div class="row">
      <input id="approveAmt" placeholder="Amount in TKN (e.g. 1000)"/>
      <button id="approveBtn">Approve</button>
    </div>
    <div class="tiny sub">Approval is a <b>VALUE = 0</b> transaction. TKN uses 18 decimals.</div>
  </div>

  <div class="card">
    <h3>2) Add Liquidity</h3>
    <div class="row">
      <input id="liqZTC" placeholder="ZTC to add (e.g. 0.1)"/>
      <input id="liqTKN" placeholder="TKN to add (e.g. 100)"/>
      <button id="addLiqBtn" class="ok">Add Liquidity</button>
    </div>
    <div class="tiny sub">Sends native ZTC (as VALUE) and transfers TKN from your wallet to the pool.</div>
  </div>

  <div class="card">
    <h3>3) Swap</h3>
    <div class="row">
      <input id="swapZTC" placeholder="ZTC → TKN amount (e.g. 0.01)"/>
      <button id="swapZ2T" class="ok">Swap ZTC → TKN</button>
    </div>
    <div class="row">
      <input id="swapTKN" placeholder="TKN → ZTC amount (e.g. 10)"/>
      <button id="swapT2Z" class="ok">Swap TKN → ZTC</button>
    </div>
    <div class="tiny sub">ZTC→TKN requires VALUE &gt; 0; TKN→ZTC requires VALUE = 0 and enough allowance.</div>
  </div>

  <div class="card">
    <b>Activity</b>
    <div id="log" class="mono"></div>
  </div>

  <!-- “Về ZenChain” – thêm màu sắc & hình ảnh -->
  <div class="card">
    <h3>About ZenChain</h3>
    <div class="features">
      <div class="feature">
        <h4>Fast finality</h4>
        <div class="sub">Snappy confirmations for a smooth DEX UX.</div>
      </div>
      <div class="feature">
        <h4>Low fees</h4>
        <div class="sub">ZTC gas stays cheap even at peak.</div>
      </div>
      <div class="feature">
        <h4>EVM compatible</h4>
        <div class="sub">Drop-in contracts, familiar toolchain.</div>
      </div>
    </div>
    <div class="gallery" style="margin-top:12px">
      <div class="g"><img src="./zenchain-logo.png?v=2" onerror="this.src='./zenchain-logo.jpg?v=2'"></div>
      <div class="g"><img src="./zenchain-logo.png?v=2" onerror="this.src='./zenchain-logo.jpg?v=2'"></div>
      <div class="g"><img src="./zenchain-logo.png?v=2" onerror="this.src='./zenchain-logo.jpg?v=2'"></div>
    </div>
  </div>
</div>

<script>
/************** helpers **************/
const log=(m,cls="")=>{const el=document.getElementById("log");const d=document.createElement("div");d.innerHTML=m;if(cls)d.classList.add(cls);el.prepend(d)};
const fmt=(n,dec=6)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:dec});
function setConnectUI(connected, addr=""){
  const btn=document.getElementById("connectBtn");
  if(connected){ btn.textContent="✅ Connected"; btn.classList.add("connected"); btn.disabled=true; document.getElementById("acct").textContent=`account: ${addr}`; }
  else{ btn.textContent="🦊 Connect Wallet"; btn.classList.remove("connected"); btn.disabled=false; document.getElementById("acct").textContent="account: not connected"; }
}
function disableTx(disabled){
  ["approveBtn","addLiqBtn","swapZ2T","swapT2Z"].forEach(id=>{ const b=document.getElementById(id); if(b) b.disabled=disabled; });
}

/************** ABIs **************/
const DEX_ABI=[
  "function addLiquidity(uint256 tokenAmount) payable",
  "function swapZTCforToken() payable",
  "function swapTokenForZTC(uint256 tokenIn)",
  "function reserveToken() view returns (uint256)",
  "function reserveZTC() view returns (uint256)",
  "function token() view returns (address)"
];
const TKN_ABI=[
  "function approve(address spender, uint256 value) returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];

/************** globals **************/
let provider, signer, dex, tkn, tknDecimals=18, tknSymbol="TKN";
let DEX_ADDRESS = localStorage.getItem("dex") || document.getElementById("dexAddr").value.trim();
let TKN_ADDRESS = localStorage.getItem("tkn") || document.getElementById("tknAddr").value.trim();
document.getElementById("dexAddr").value=DEX_ADDRESS;
document.getElementById("tknAddr").value=TKN_ADDRESS;

/************** connect & network **************/
async function ensureZenChain(){
  const zen={chainId:"0x20D8",chainName:"ZenChain Testnet",
    nativeCurrency:{name:"ZenCoin",symbol:"ZTC",decimals:18},
    rpcUrls:["https://zenchain-testnet.api.onfinality.io/public"],
    blockExplorerUrls:["https://zentrace.io"]};
  try{
    await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:zen.chainId}]});
  }catch(e){ if(e.code===4902){await window.ethereum.request({method:"wallet_addEthereumChain",params:[zen]});} else {throw e;} }
}
async function connect(){
  try{
    if(typeof ethers==='undefined') throw new Error("Ethers failed to load. Hard refresh.");
    if(!window.ethereum) { alert("Please install MetaMask."); return; }
    provider=new ethers.BrowserProvider(window.ethereum);
    await ensureZenChain();
    await provider.send("eth_requestAccounts",[]);
    signer=await provider.getSigner();
    const me=await signer.getAddress(); const net=await provider.getNetwork();
    document.getElementById("net").textContent=`network: ${Number(net.chainId)}`;
    setConnectUI(true, me);
    await initContracts(); await refreshBalances();
    log("✅ Wallet connected.","oktxt");
    // listeners
    window.ethereum.removeAllListeners?.("accountsChanged");
    window.ethereum.removeAllListeners?.("chainChanged");
    window.ethereum.on("accountsChanged", async accs => {
      if(!accs.length){ setConnectUI(false); return; }
      setConnectUI(true, accs[0]); await refreshBalances();
    });
    window.ethereum.on("chainChanged", ()=>location.reload());
  }catch(err){ setConnectUI(false); log("❌ Connect failed: "+(err?.message||err),"errtxt"); }
}

/************** contracts & balances **************/
async function initContracts(){
  dex=new ethers.Contract(DEX_ADDRESS, DEX_ABI, signer);
  tkn=new ethers.Contract(TKN_ADDRESS, TKN_ABI, signer);
  try{ tknDecimals=await tkn.decimals(); tknSymbol=await tkn.symbol(); }catch{}
}
async function refreshBalances(){
  try{
    const me=await signer.getAddress();
    const [balZ,balT,alw,rZ,rT]=await Promise.all([
      provider.getBalance(me), tkn.balanceOf(me), tkn.allowance(me,DEX_ADDRESS), dex.reserveZTC(), dex.reserveToken()
    ]);
    document.getElementById("balZTC").textContent = fmt(ethers.formatEther(balZ));
    document.getElementById("balTKN").textContent = fmt(ethers.formatUnits(balT,tknDecimals));
    document.getElementById("allow").textContent  = fmt(ethers.formatUnits(alw,tknDecimals));
    document.getElementById("rZTC").textContent   = fmt(ethers.formatEther(rZ));
    document.getElementById("rTKN").textContent   = fmt(ethers.formatUnits(rT,tknDecimals));
  }catch(err){ log("⚠️ Could not fetch balances: "+(err?.message||err),"warnxt"); }
}
function requireConnected(){ if(!signer){ log("⚠️ Please connect wallet first.","warnxt"); return false; } return true; }

/************** actions **************/
async function doApprove(){
  if(!requireConnected()) return;
  try{
    disableTx(true);
    const n=(document.getElementById("approveAmt").value||"1000").trim();
    const amt=ethers.parseUnits(n,tknDecimals);
    const tx=await tkn.approve(DEX_ADDRESS,amt);
    log(`⏳ Approve submitted: <a href="https://zentrace.io/tx/${tx.hash}" target="_blank">view tx</a>`);
    await tx.wait(); log("✅ Approve confirmed.","oktxt"); await refreshBalances();
  }catch(err){ log("❌ Approve failed: "+(err?.shortMessage||err?.message||err),"errtxt"); }
  finally{ disableTx(false); }
}
async function addLiquidity(){
  if(!requireConnected()) return;
  try{
    disableTx(true);
    const z=(document.getElementById("liqZTC").value||"0.1").trim();
    const t=(document.getElementById("liqTKN").value||"100").trim();
    const tx=await dex.addLiquidity(ethers.parseUnits(t,tknDecimals), {value:ethers.parseEther(z)});
    log(`⏳ Add liquidity: <a href="https://zentrace.io/tx/${tx.hash}" target="_blank">view tx</a>`);
    await tx.wait(); log("✅ Liquidity added.","oktxt"); await refreshBalances();
  }catch(err){ log("❌ Add liquidity failed: "+(err?.shortMessage||err?.message||err),"errtxt"); }
  finally{ disableTx(false); }
}
async function swapZ2T(){
  if(!requireConnected()) return;
  try{
    disableTx(true);
    const z=(document.getElementById("swapZTC").value||"0.01").trim();
    const tx=await dex.swapZTCforToken({value:ethers.parseEther(z)});
    log(`⏳ Swap ZTC→TKN: <a href="https://zentrace.io/tx/${tx.hash}" target="_blank">view tx</a>`);
    await tx.wait(); log("✅ Swap ZTC→TKN confirmed.","oktxt"); await refreshBalances();
  }catch(err){ log("❌ Swap ZTC→TKN failed: "+(err?.shortMessage||err?.message||err),"errtxt"); }
  finally{ disableTx(false); }
}
async function swapT2Z(){
  if(!requireConnected()) return;
  try{
    disableTx(true);
    const tStr=(document.getElementById("swapTKN").value||"10").trim();
    const need=ethers.parseUnits(tStr,tknDecimals);

    // Kiểm tra allowance trước khi gọi
    const owner=await signer.getAddress();
    const alw=await tkn.allowance(owner, DEX_ADDRESS);
    if(alw < need){
      const lack=ethers.formatUnits(need - alw, tknDecimals);
      log(`⚠️ Allowance is not enough. Please Approve ≥ ${tStr} TKN (missing ~${lack}).`, "warnxt");
      disableTx(false);
      return;
    }

    const tx=await dex.swapTokenForZTC(need); // VALUE = 0
    log(`⏳ Swap TKN→ZTC: <a href="https://zentrace.io/tx/${tx.hash}" target="_blank">view tx</a>`);
    await tx.wait(); log("✅ Swap TKN→ZTC confirmed.","oktxt"); await refreshBalances();
  }catch(err){ log("❌ Swap TKN→ZTC failed: "+(err?.shortMessage||err?.message||err),"errtxt"); }
  finally{ disableTx(false); }
}

/************** wiring **************/
document.getElementById("connectBtn").onclick=connect;
document.getElementById("approveBtn").onclick=doApprove;
document.getElementById("addLiqBtn").onclick=addLiquidity;
document.getElementById("swapZ2T").onclick=swapZ2T;
document.getElementById("swapT2Z").onclick=swapT2Z;
document.getElementById("saveAddr").onclick=()=>{
  DEX_ADDRESS=document.getElementById("dexAddr").value.trim();
  TKN_ADDRESS=document.getElementById("tknAddr").value.trim();
  localStorage.setItem("dex",DEX_ADDRESS); localStorage.setItem("tkn",TKN_ADDRESS);
  log("Addresses saved. Reinitializing…"); if(signer) initContracts().then(refreshBalances);
};

/* Auto-connect nếu từng grant trước đó */
(async()=>{ if(window.ethereum){ try{ const accs=await window.ethereum.request({method:"eth_accounts"}); if(accs?.length){ await connect(); } }catch{} } })();
</script>
</body>
</html>
